<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Laundry System - Dashboard</title>
    
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
        /* (CSS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) */
        body {
            font-family: "Poppins", sans-serif;
            background: #e7f5ff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
        }
        .app-container {
            max-width: 1000px;
            width: 95%;
            margin: 20px auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        .view {
            display: none;
            padding: 30px 40px;
        }
        .primary-btn {
            padding: 14px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 123, 255, 0.4);
            filter: brightness(1.1);
        }
        .primary-btn:active {
            transform: translateY(0);
        }
        .tab-btn {
            display: inline-block;
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            font-weight: 500;
            text-decoration: none;
            border-bottom-width: 2px;
            border-color: transparent;
        }
        .tab-btn:hover {
             border-color: #9ca3af;
             color: #333;
        }
        .tab-btn.active {
            color: #007bff;
            font-weight: 600;
            border-color: #007bff;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }
        .update-machine-btn {
             padding: 8px 16px;
             font-size: 14px;
             font-weight: 500;
        }
        .admin-slot-btn {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .admin-btn-available {
             background-color: #ecfdf5; color: #067647; border: 1px solid #a7f3d0;
        }
        .admin-btn-available:hover {
            background-color: #d1fae5; color: #046c4e;
        }
        .admin-btn-taken {
            background-color: #fffbeb; color: #b45309; border: 1px solid #fde68a;
        }
        .admin-btn-taken:hover {
            background-color: #fef3c7; color: #92400e;
        }
    </style>
</head>
<body>

<div class="app-container">
    <nav id="navbar" class="p-4 border-b border-gray-200 flex justify-between items-center rounded-t-xl bg-white">
        <h1 class="text-2xl font-bold text-gray-800">Laundry Hub</h1>
        <div class="flex space-x-4 items-center">
            <div id="nav-tabs" class="space-x-2">
                <button data-target="dashboard-view" class="tab-btn active">Dashboard</button>
                <a th:if="${currentUser.role.toString() == 'STUDENT'}" 
                   th:href="@{/student/{studentId}/booking(studentId=${currentUser.studentId})}" 
                   class="tab-btn">Booking</a>
                <button th:if="${currentUser.role.toString() == 'MANAGER'}" data-target="admin-view" id="nav-admin-link" class="tab-btn">Admin Panel</button>
            </div>
            <span id="user-info" class="text-sm text-gray-600 font-medium sm:inline"
                  th:text="${currentUser.name} + ' (' + ${currentUser.role} + ')'">
                User Name (Role)
            </span>
        </div>
    </nav>

    <div id="message-box" class="fixed top-5 right-5 z-50"></div>
    
    <div id="dashboard-view" class="view" style="display:block;">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Welcome, <span id="user-display-name" th:text="${currentUser.name}">User</span></h2>

        <div id="student-dashboard" th:if="${currentUser.role.toString() == 'STUDENT'}">
            <h3 class="text-xl font-semibold mb-4 text-blue-800">Your Bookings</h3>
            <div id="student-bookings" class="space-y-4">
                <div th:if="${#lists.isEmpty(studentBookings)}">
                    <p class="text-gray-500">No active bookings found. Ready to do some laundry?</p>
                </div>
                <div th:unless="${#lists.isEmpty(studentBookings)}" th:each="booking : ${studentBookings}" 
                     class="card flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-900" th:text="${booking.machine.machineNumber}">Washer 1</p>
                        <p class="text-sm text-gray-600" th:text="'Slot Time: ' + ${#temporals.format(booking.bookingDate, 'dd MMM yyyy, HH:mm')}">Slot Time: 2025-11-03 10:00</p>
                    </div>
                    <span class="text-sm font-semibold px-3 py-1 rounded-full"
                          th:text="${booking.status}"
                          th:classappend="${booking.status.toString() == 'CONFIRMED' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">
                        PENDING
                    </span>
                </div>
            </div>
            <h3 class="text-xl font-semibold mt-8 mb-4 text-blue-800">Quick Status Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="dashboard-stats">
                 <div class="card !bg-blue-500 text-white"><p class="text-sm opacity-80">Total Machines</p><p class="text-3xl font-bold mt-1" th:text="${studentStats.totalMachines}">0</p></div>
                 <div class="card !bg-emerald-500 text-white"><p class="text-sm opacity-80">Machines Available</p><p class="text-3xl font-bold mt-1" th:text="${studentStats.availableMachines}">0</p></div>
                 <div class="card !bg-amber-500 text-white"><p class="text-sm opacity-80">Machines In Use</p><p class="text-3xl font-bold mt-1" th:text="${studentStats.inUseMachines}">0</p></div>
            </div>
            <p class="mt-8 text-center">
                <a th:href="@{/student/{studentId}/booking(studentId=${currentUser.studentId})}" class="primary-btn">Go to Booking Page</a>
            </p>
        </div>

        <div id="manager-dashboard" th:if="${currentUser.role.toString() == 'MANAGER'}">
            <h3 class="text-xl font-semibold mb-4 text-blue-800">System Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6" id="manager-dashboard-stats">
                <div class="card !bg-blue-500 text-white"><p class="text-sm opacity-80">Total Machines</p><p class="text-3xl font-bold mt-1" th:text="${managerStats.totalMachines}">0</p></div>
                <div class="card !bg-emerald-500 text-white"><p class="text-sm opacity-80">Machines Available</p><p class="text-3xl font-bold mt-1" th:text="${managerStats.availableMachines}">0</p></div>
                <div class="card !bg-amber-500 text-white"><p class="text-sm opacity-80">Machines In Use</p><p class="text-3xl font-bold mt-1" th:text="${managerStats.inUseMachines}">0</p></div>
                <div class="card !bg-red-500 text-white"><p class="text-sm opacity-80">Maintenance / Offline</p><p class="text-3xl font-bold mt-1" th:text="${managerStats.maintenanceMachines}">0</p></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                <div class="lg:col-span-2 card">
                    <h3 class="text-xl font-semibold mb-4">Recent Activity (‡πÄ‡∏ß‡∏•‡∏≤ / ‡πÉ‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ)</h3>
                    <div class="space-y-4 max-h-96 overflow-y-auto">
                        <div th:if="${#lists.isEmpty(recentActivities)}">
                            <p class="text-gray-500">No recent activity found.</p>
                        </div>
                        <div th:unless="${#lists.isEmpty(recentActivities)}" th:each="booking : ${recentActivities}" 
                             class="flex items-center justify-between p-3 border-b hover:bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold"
                                     th:text="${booking.getCustomerInitial()}">?</div>
                                <div>
                                    <p class="font-bold text-gray-900">
                                        <span th:text="${booking.user.name}">User Name</span>
                                        <span class="font-normal text-gray-600"> booked </span>
                                        <span th:text="${booking.machine.name}">Machine Name</span>
                                    </p>
                                    <p class="text-sm text-gray-500" 
                                       th:text="'Slot Time: ' + ${#temporals.format(booking.bookingDate, 'dd MMM yyyy, HH:mm')}">
                                        Slot Time: 3 Nov 2025, 10:00
                                    </p>
                                </div>
                            </div>
                            <span class="text-sm font-semibold px-3 py-1 rounded-full"
                                  th:text="${booking.status}"
                                  th:classappend="${booking.status.toString() == 'COMPLETED' ? 'bg-gray-100 text-gray-600' : (booking.status.toString() == 'CONFIRMED' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700')}">
                                STATUS
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">User Overview</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center mb-4">
                            <span class="font-medium text-gray-600">Total Users</span>
                            <span class="text-2xl font-bold text-blue-600" th:text="${managerStats.totalUsers}">0</span>
                        </div>
                        <ul id="admin-user-summary" class="space-y-3 max-h-80 overflow-y-auto">
                            <li th:each="user : ${allUsers}" class="flex justify-between items-center border-t pt-2">
                                <span class="font-medium" th:text="${user.name}">User Name</span>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full" 
                                      th:text="${user.role}"
                                      th:classappend="${user.role.toString() == 'MANAGER' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">
                                    Role
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-view" class="view" th:if="${currentUser.role.toString() == 'MANAGER'}" style="display:none;">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Manager Administration Panel</h2>
        
        <div class="card mb-8">
            <h3 class="text-xl font-semibold mb-4">Today's Schedule Management (‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏ß‡∏•‡∏≤)</h3>
            <div id="admin-schedule-list" class="space-y-4 max-h-[60vh] overflow-y-auto">
                <p>Loading schedule...</p>
            </div>
        </div>
        
        <div class="card">
            <h3 class="text-xl font-semibold mb-4">Machine Status Control (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</h3>
            <div id="admin-machine-list" class="space-y-4">
                
                <div th:each="machine : ${allMachines}" class="flex items-center justify-between p-3 border-b hover:bg-gray-50 rounded-lg transition duration-150">
                    <div class="flex-grow">
                        <p class="font-bold" th:text="${machine.name} + ' (' + ${machine.machineNumber} + ')'">Washer 1 (001)</p>
                        <p class="text-sm" 
                           th:text="'Current: ' + ${machine.status}"
                           th:classappend="${machine.status == 'AVAILABLE' ? 'text-emerald-600' : 'text-red-600'}">
                           Current: Status
                        </p>
                    </div>
                    <div class="flex items-center">
                        <select th:data-id="${machine.id}" class="machine-status-select border border-gray-300 rounded-md p-1 text-sm mr-4 w-40">
                            <option th:each="status : ${allStatuses}"
                                    th:value="${status}"
                                    th:text="${status}"
                                    th:selected="${status == machine.status}">
                                Status
                            </option>
                        </select>
                        <button th:data-id="${machine.id}" class="update-machine-btn primary-btn">Update</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    
    // (‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Controller ‡∏°‡∏≤‡πÉ‡∏´‡πâ JavaScript)
    const csrfToken = /*[[${_csrf?.token}]]*/ null;
    const csrfHeader = /*[[${_csrf?.headerName}]]*/ null;
    var allMachines = /*[[${allMachines}]]*/ []; // (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'var' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ)
    var todaysBookings = /*[[${todaysBookings}]]*/ []; // (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'var')
    const currentManager = /*[[${currentUser}]]*/ null;

    // --- (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°) ---
    function showMessage(message, type = 'info') {
        const baseClass = "p-4 mb-2 rounded-lg shadow-lg text-white font-semibold transition-opacity duration-300";
        let colorClass = type === 'success' ? 'bg-emerald-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500');
        const $msg = $(`<div class="${baseClass} ${colorClass}">${message}</div>`);
        $('#message-box').append($msg);
        $msg.fadeIn(300).delay(3000).fadeOut(500, function() { $(this).remove(); });
    }

    // --- (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö) ---
    function showView(viewId) {
        $('.view').hide();
        $(`#${viewId}`).show();
        $('#nav-tabs .tab-btn').removeClass('active');
        $(`#nav-tabs .tab-btn[data-target="${viewId}"]`).addClass('active');
    }

    // --- (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "Update" ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á) ---
    $(document).on('click', '.update-machine-btn', function() {
        const $btn = $(this);
        const machineId = $btn.data('id');
        const $select = $(`.machine-status-select[data-id="${machineId}"]`);
        const newStatus = $select.val();
        if (!machineId) return;
        $btn.text('Saving...').prop('disabled', true);

        $.ajax({
            type: 'PUT',
            url: '/api/machines/' + machineId + '/status', 
            contentType: 'application/x-www-form-urlencoded',
            data: { status: newStatus },
            dataType: 'json',
            beforeSend: function(xhr) { if (csrfHeader && csrfToken) xhr.setRequestHeader(csrfHeader, csrfToken); },
            success: function(response) {
                const returnedStatus = response.status || newStatus; 
                showMessage(`${response.name} status updated to: ${returnedStatus}`, 'success');
                
                // (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
                const $statusText = $btn.closest('.flex').find('p.text-sm');
                $statusText.text('Current: ' + returnedStatus);
                $statusText.removeClass('text-emerald-600 text-red-600');
                $statusText.addClass(response.status === 'AVAILABLE' ? 'text-emerald-600' : 'text-red-600');

                // --- ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è (‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ Logic ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤) ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è ---
                
                // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô Array ‡∏´‡∏•‡∏±‡∏Å
                const machineIndex = allMachines.findIndex(m => m.id === machineId);
                if (machineIndex > -1) {
                    // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô Array
                    allMachines[machineIndex].status = returnedStatus;
                }
                
                // 3. ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤ "Admin Panel" ‡πÉ‡∏´‡∏°‡πà
                // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 'MAINTENANCE' ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á)
                renderAdminSchedule();
                
                // --- ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è (‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°) ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è ---
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? (xhr.responseJSON.message || xhr.responseJSON.error) : 'Update failed.';
                showMessage(errorMsg, 'error');
            },
            complete: function() {
                $btn.text('Update').prop('disabled', false);
            }
        });
    });

    // --- (JavaScript ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "Schedule Management") ---
    
    // (‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "YYYY-MM-DD")
    function getTodaysDateString() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤)
    function renderAdminSchedule() {
        const $list = $("#admin-schedule-list").empty();
        const todayStr = getTodaysDateString();
        
        const bookingLookup = new Map();
        todaysBookings.forEach(booking => {
            const key = `${booking.machine.id}-${booking.bookingDate}`;
            bookingLookup.set(key, booking);
        });

        const timeSlots = ["08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00"];

        let hasAvailableMachines = false; // (‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÑ‡∏´‡∏°)

        allMachines.forEach(machine => {
            
            // --- ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è (‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ Logic ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤) ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è ---
            // (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏ã‡πà‡∏≠‡∏° (MAINTENANCE) ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡πÄ‡∏•‡∏¢)
            if (machine.status === 'MAINTENANCE' || machine.status === 'OUT_OF_SERVICE') {
                return; // (‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ)
            }
            // --- ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è (‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°) ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è ---
            
            hasAvailableMachines = true; // (‡πÄ‡∏à‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
            let slotButtonsHTML = "";

            timeSlots.forEach(slotTime => {
                const isoSlotTime = `${todayStr}T${slotTime}:00`;
                const lookupKey = `${machine.id}-${isoSlotTime}`;
                const booking = bookingLookup.get(lookupKey);

                if (booking) {
                    // (‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ "‡πÄ‡∏ï‡πá‡∏°")
                    let userName = booking.user ? booking.user.name : "Unknown";
                    if(booking.user.id === currentManager.id) userName = "ADMIN BLOCK";
                    
                    slotButtonsHTML += `
                        <div class="text-center">
                            <span class="text-xs font-semibold text-gray-700">${slotTime}</span>
                            <button class="admin-slot-btn admin-btn-taken w-full mt-1 btn-cancel-booking" 
                                    data-booking-id="${booking.id}">
                                üî¥ ${userName}
                            </button>
                        </div>
                    `;
                } else {
                    // (‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ "‡∏ß‡πà‡∏≤‡∏á")
                    slotButtonsHTML += `
                        <div class="text-center">
                            <span class="text-xs font-semibold text-gray-700">${slotTime}</span>
                            <button class="admin-slot-btn admin-btn-available w-full mt-1 btn-block-slot" 
                                    data-machine-id="${machine.id}"
                                    data-slot-time="${isoSlotTime}">
                                üü¢ AVAILABLE
                            </button>
                        </div>
                    `;
                }
            });

            const machineCardHTML = `
                <div class="card p-4 border-b">
                    <h4 class="font-bold text-gray-800 mb-3">${machine.name} (${machine.machineNumber})</h4>
                    <div class="grid grid-cols-5 gap-3">
                        ${slotButtonsHTML}
                    </div>
                </div>
            `;
            $list.append(machineCardHTML);
        });

        // (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á AVAILABLE ‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
        if (!hasAvailableMachines) {
            $list.html('<p class="text-gray-500">All machines are currently under maintenance or out of service.</p>');
        }
    }

    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° [Cancel Booking])
    $(document).on('click', '.btn-cancel-booking', function() {
        const $btn = $(this);
        const bookingId = $btn.data('booking-id');
        
        if (!confirm("Are you sure you want to cancel this booking?")) return;
        
        $btn.text('Cancelling...').prop('disabled', true);

        $.ajax({
            type: 'DELETE',
            url: '/api/bookings/' + bookingId,
            beforeSend: function(xhr) { if (csrfHeader && csrfToken) xhr.setRequestHeader(csrfHeader, csrfToken); },
            success: function() {
                showMessage('Booking cancelled successfully!', 'success');
                // (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Array ‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà)
                todaysBookings = todaysBookings.filter(b => b.id !== bookingId);
                renderAdminSchedule();
            },
            error: function(xhr) {
                showMessage('Failed to cancel booking.', 'error');
                $btn.text('üî¥ TAKEN').prop('disabled', false);
            }
        });
    });

    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° [Block Slot])
    $(document).on('click', '.btn-block-slot', function() {
        const $btn = $(this);
        const machineId = $btn.data('machine-id');
        const slotTime = $btn.data('slot-time');
        
        if (!confirm("Are you sure you want to block this slot?")) return;

        $btn.text('Blocking...').prop('disabled', true);
        
        const bookingData = {
          user: { id: currentManager.id }, 
          machine: { id: machineId }, 
          bookingDate: slotTime, 
          amount: 0.0,
          service: "ADMIN_BLOCK",
          status: "CONFIRMED"
        };

        $.ajax({
            type: 'POST',
            url: '/api/bookings',
            contentType: 'application/json',
            data: JSON.stringify(bookingData),
            dataType: 'json',
            beforeSend: function(xhr) { if (csrfHeader && csrfToken) xhr.setRequestHeader(csrfHeader, csrfToken); },
            success: function(newBooking) {
                showMessage('Slot blocked successfully!', 'success');
                // (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Array ‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà)
                // (‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ newBooking ‡∏°‡∏µ machine ‡πÅ‡∏•‡∏∞ user object ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô)
                // (‡∏ã‡∏∂‡πà‡∏á Controller ‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á Service ‡πÉ‡∏´‡πâ return Booking ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)
                
                // (‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏Ñ‡∏∑‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• machine/user ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà)
                newBooking.user = currentManager;
                newBooking.machine = allMachines.find(m => m.id === machineId);
                
                todaysBookings.push(newBooking);
                renderAdminSchedule();
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? (xhr.responseJSON.message || xhr.responseJSON.error) : 'Failed to block slot.';
                showMessage(errorMsg, 'error');
                $btn.text('üü¢ AVAILABLE').prop('disabled', false);
            }
        });
    });
    
    // --- (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô) ---
    $(document).ready(function() {
        $(document).on('click', '#nav-tabs button.tab-btn', function() {
            const target = $(this).data('target');
            showView(target);
        });
        
        $('#nav-tabs button.tab-btn[data-target="dashboard-view"]').addClass('active');

        // (‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô Admin Panel ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤)
        if(currentManager && currentManager.role === 'MANAGER') {
            renderAdminSchedule();
        }
    });

</script>
</body>
</html>