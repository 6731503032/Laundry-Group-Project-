<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Laundry System - Dashboard</title>
    
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- 1. เปลี่ยน Font เป็น Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
        /* 2. เปลี่ยน Style ทั้งหมดให้ตรงกับ Login.html */
        body {
            font-family: "Poppins", sans-serif;
            background: #e7f5ff; /* สีพื้นหลังฟ้าอ่อน */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0; /* เพิ่ม padding */
        }
        .app-container {
            max-width: 1000px;
            width: 95%;
            margin: 20px auto;
            background: white; /* พื้นหลังขาว */
            border-radius: 16px; /* ขอบมน 16px */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* เงา */
            overflow: hidden;
        }
        .view {
            display: none;
            padding: 30px 40px; /* เพิ่ม Padding */
        }
        /* 3. Style ปุ่มหลัก (สีน้ำเงิน) */
        .primary-btn {
            padding: 14px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none; /* สำหรับแท็ก <a> */
            display: inline-block; /* สำหรับแท็ก <a> */
            text-align: center;
        }
        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 123, 255, 0.4);
            filter: brightness(1.1);
        }
        .primary-btn:active {
            transform: translateY(0);
        }
        /* 4. Style Tabs (แก้ .tab-btn) */
        .tab-btn {
            display: inline-block;
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            font-weight: 500;
            text-decoration: none;
            border-bottom-width: 2px;
            border-color: transparent;
        }
        .tab-btn:hover {
             border-color: #9ca3af;
             color: #333;
        }
        .tab-btn.active {
            color: #007bff;
            font-weight: 600;
            border-color: #007bff; /* ใช้ border-color แทน ::after เพื่อความง่าย */
        }
        /* 5. Style Card (ที่โชว์เครื่องซักผ้า) */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }
        
        /* 6. Style สำหรับปุ่ม 'Update' ใน Admin Panel (ให้เล็กลง) */
        .update-machine-btn {
             padding: 8px 16px; /* ลด padding */
             font-size: 14px; /* ลด font */
             font-weight: 500;
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Navbar (ใช้ bg-white) -->
    <nav id="navbar" class="p-4 border-b border-gray-200 flex justify-between items-center rounded-t-xl bg-white">
        <h1 class="text-2xl font-bold text-gray-800">Laundry Hub</h1>
        <div class="flex space-x-4 items-center">
            <div id="nav-tabs" class="space-x-2">
                <button data-target="dashboard-view" class="tab-btn active">Dashboard</button>
                
                <a th:if="${currentUser.role.toString() == 'STUDENT'}" 
                   th:href="@{/student/{studentId}/booking(studentId=${currentUser.studentId})}" 
                   class="tab-btn">Booking</a>
                       
                <button th:if="${currentUser.role.toString() == 'MANAGER'}" data-target="admin-view" id="nav-admin-link" class="tab-btn">Admin Panel</button>
            </div>
            <span id="user-info" class="text-sm text-gray-600 font-medium sm:inline"
                  th:text="${currentUser.name} + ' (' + ${currentUser.role} + ')'">
                User Name (Role)
            </span>
        </div>
    </nav>

    <div id="message-box" class="fixed top-5 right-5 z-50"></div>
    
    <div id="dashboard-view" class="view" style="display:block;">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Welcome, <span id="user-display-name" th:text="${currentUser.name}">User</span></h2>

        <div id="student-dashboard" th:if="${currentUser.role.toString() == 'STUDENT'}">
            <h3 class="text-xl font-semibold mb-4 text-blue-800">Your Bookings</h3>
            <div id="student-bookings" class="space-y-4">
                <div th:if="${#lists.isEmpty(studentBookings)}">
                    <p class="text-gray-500">No active bookings found. Ready to do some laundry?</p>
                </div>
                <!-- การ์ด Booking (ใช้ .card ที่เราแก้สไตล์แล้ว) -->
                <div th:unless="${#lists.isEmpty(studentBookings)}" th:each="booking : ${studentBookings}" 
                     class="card flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-900" th:text="${booking.machine.machineNumber}">Washer 1</p>
                        <p class="text-sm text-gray-600" th:text="'Date: ' + ${booking.bookingDate}">Date: 2025-11-01T18:00:00</p>
                    </div>
                    
                    <span class="text-sm font-semibold px-3 py-1 rounded-full"
                          th:text="${booking.status}"
                          th:classappend="${booking.status.toString() == 'CONFIRMED' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">
                        PENDING
                    </span>
                </div>
            </div>

            <h3 class="text-xl font-semibold mt-8 mb-4 text-blue-800">Quick Status Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="dashboard-stats">
                 <!-- การ์ด Stats (ใช้ .card ที่เราแก้สไตล์แล้ว แต่เพิ่มสีพื้นหลัง) -->
                 <div class="card !bg-blue-500 text-white"><p class="text-sm opacity-80">Total Machines</p><p class="text-3xl font-bold mt-1" th:text="${studentStats.totalMachines}">0</p></div>
                 <div class="card !bg-emerald-500 text-white"><p class="text-sm opacity-80">Machines Available</p><p class="text-3xl font-bold mt-1" th:text="${studentStats.availableMachines}">0</p></div>
                 <div class="card !bg-amber-500 text-white"><p class="text-sm opacity-80">Machines In Use</p><p class="text-3xl font-bold mt-1" th:text="${studentStats.inUseMachines}">0</p></div>
            </div>
            <p class="mt-8 text-center">
                <!-- ปุ่ม Booking (ใช้ .primary-btn ที่เราแก้สไตล์แล้ว) -->
                <a th:href="@{/student/{studentId}/booking(studentId=${currentUser.studentId})}" class="primary-btn">Go to Booking Page</a>
            </p>
        </div>

        <div id="manager-dashboard" th:if="${currentUser.role.toString() == 'MANAGER'}">
            <!-- (Manager content - ไม่ได้แก้) -->
        </div>
    </div>

    <div id="admin-view" class="view" th:if="${currentUser.role.toString() == 'MANAGER'}">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Manager Administration Panel</h2>
         <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 card">
                <h3 class="text-xl font-semibold mb-4">Machine Status Control</h3>
                <div id="admin-machine-list" class="space-y-4">
                    <div th:each="machine : ${allMachines}" class="flex items-center justify-between p-3 border-b hover:bg-gray-50 rounded-lg transition duration-150">
                        <div class="flex-grow">
                            <p class="font-bold" th:text="${machine.machineNumber} + ' (' + ${machine.id} + ')'">Machine Name (ID)</p>
                            <p class="text-sm" 
                               th:text="'Current: ' + ${machine.status}"
                               th:classappend="${machine.status == 'Available' ? 'text-emerald-600' : (machine.status == 'In Use' ? 'text-orange-600' : 'text-red-600')}">
                               Current: Status
                            </p>
                        </div>
                        <select th:data-id="${machine.id}" class="machine-status-select border border-gray-300 rounded-md p-1 text-sm mr-4 w-40">
                            <option th:each="status : ${allStatuses}"
                                    th:value="${status}"
                                    th:text="${status}"
                                    th:selected="${status == machine.status}">
                                Status
                            </option>
                        </select>
                        <!-- ปุ่ม Update (ใช้ .primary-btn และ .update-machine-btn) -->
                        <button th:data-id="${machine.id}" class="update-machine-btn primary-btn">Update</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="text-xl font-semibold mb-4">User Management Summary</h3>
                <ul id="admin-user-summary" class="space-y-3">
                     <li th:each="user : ${allUsers}" class="flex justify-between items-center border-b pb-2">
                         <span class="font-medium" th:text="${user.name}">User Name</span>
                         <span class="text-xs font-semibold px-2 py-0.5 rounded-full" 
                               th:text="${user.role}"
                               th:classappend="${user.role.toString() == 'MANAGER' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}"> <!-- แก้ไข bg-blue-1s00 -->
                             Role
                         </span>
                         <span class="text-xs text-gray-500" th:text="${user.id}">User ID</span>
                     </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- (JavaScript ไม่มีการเปลี่ยนแปลง) -->
<script>
    function showMessage(message, type = 'info') {
        const baseClass = "p-4 mb-2 rounded-lg shadow-lg text-white font-semibold transition-opacity duration-300";
        let colorClass = type === 'success' ? 'bg-emerald-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500');
        const $msg = $(`<div class="${baseClass} ${colorClass}">${message}</div>`);
        $('#message-box').append($msg);
        $msg.fadeIn(300).delay(3000).fadeOut(500, function() { $(this).remove(); });
    }

    function showView(viewId) {
        $('.view').hide();
        $(`#${viewId}`).show();
        
        $('#nav-tabs .tab-btn').removeClass('active');
        // แก้ไขให้รองรับทั้ง <a> และ <button>
        $(`#nav-tabs .tab-btn[data-target="${viewId}"]`).addClass('active');
        $(`#nav-tabs a.tab-btn[href*="${viewId}"]`).addClass('active');
    }

    $(document).on('click', '.update-machine-btn', function() {
        const $btn = $(this);
        const machineId = $btn.data('id');
        const $select = $(`.machine-status-select[data-id="${machineId}"]`);
        const newStatus = $select.val();

        if (!machineId) return;

        $btn.text('Saving...').prop('disabled', true);

        const token = $("meta[name='_csrf']").attr("content");
        const header = $("meta[name='_csrf_header']").attr("content"); 

        $.ajax({
            type: 'POST',
            url: '/api/admin/machines/status', 
            contentType: 'application/json',
            data: JSON.stringify({
                machineId: machineId,
                newStatus: newStatus
            }),
            dataType: 'json',
            beforeSend: function(xhr) {
                if (header && token) {
                    xhr.setRequestHeader(header, token);
                }
            },
            success: function(response) {
                const returnedStatus = response.newStatus || newStatus; 
                showMessage(`${response.name} status updated to: ${returnedStatus}`, 'info');
                const $statusText = $btn.closest('.flex').find('p.text-sm');
                $statusText.text('Current: ' + returnedStatus);
                $statusText.removeClass('text-emerald-600 text-orange-600 text-red-600');
                if (returnedStatus === 'Available') {
                    $statusText.addClass('text-emerald-600');
                } else if (returnedStatus === 'In Use') {
                    $statusText.addClass('text-orange-600');
                } else {
                    $statusText.addClass('text-red-600');
                }
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Update failed.';
                showMessage(errorMsg, 'error');
            },
            complete: function() {
                $btn.text('Update').prop('disabled', false);
            }
        });
    });

    $(document).ready(function() {
        $(document).on('click', '#nav-tabs button.tab-btn', function() {
            const target = $(this).data('target');
            showView(target);
        });
        
        // ทำให้แท็บ Dashboard (ที่เป็น <button>) active เมื่อโหลดหน้า
        $('#nav-tabs button.tab-btn[data-target="dashboard-view"]').addClass('active');
    });

</script>
</body>
</html>
