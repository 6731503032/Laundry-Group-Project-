<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Campus Laundry System - Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- 1. เปลี่ยน Font เป็น Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* 2. เปลี่ยน Style ทั้งหมดให้ตรงกับ Login.html */
      body {
        font-family: "Poppins", sans-serif;
        background: #e7f5ff; /* สีพื้นหลังฟ้าอ่อน */
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px 0; /* เพิ่ม padding */
      }
      .app-container {
        max-width: 1000px;
        width: 95%;
        margin: 20px auto;
        background: white; /* พื้นหลังขาว */
        border-radius: 16px; /* ขอบมน 16px */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* เงา */
        overflow: hidden;
      }
      .view {
        display: none;
        padding: 30px 40px; /* เพิ่ม Padding */
      }
      /* 3. Style ปุ่มหลัก (สีน้ำเงิน) */
      .submit-btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }
      .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0, 123, 255, 0.4);
        filter: brightness(1.1);
      }
      .submit-btn:active {
        transform: translateY(0);
      }
      /* 4. Style ปุ่มรอง (สีเทา) */
      .cancel-btn {
        width: 100%;
        padding: 14px;
        border: 1px solid #dde1e7;
        background-color: #f8f9fa;
        color: #343a40;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }
      .cancel-btn:hover {
        background-color: #e9ecef;
        border-color: #ced4da;
      }
      .tab-btn {
        display: inline-block;
        padding: 12px 24px;
        background: none;
        border: none;
        color: #666;
        font-size: 16px;
        cursor: pointer;
        position: relative;
        transition: all 0.3s;
        font-weight: 500;
        text-decoration: none;
      }
      .tab-btn.active {
        color: #007bff;
        font-weight: 600;
      }
      .tab-btn.active::after {
        content: "";
        position: absolute;
        bottom: -2px; /* (ปรับให้เข้ากับ Navbar) */
        left: 0;
        right: 0;
        height: 2px;
        background: #007bff;
      }
      /* 5. Style Card (ที่โชว์เครื่องซักผ้า) */
      .card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e0e0;
      }
      /* 6. Style ปุ่มเลือกเวลา */
      .slot-button {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #dde1e7;
        background-color: #f8f9fa;
        color: #343a40;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        font-family: "Poppins", sans-serif;
      }
      .slot-button:hover {
        border-color: #007bff;
        color: #007bff;
        background-color: #e7f5ff;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <nav
        id="navbar"
        class="p-4 border-b border-gray-200 flex justify-between items-center rounded-t-xl bg-white"
      >
        <h1 class="text-2xl font-bold text-gray-800">Laundry Hub</h1>
        <div class="flex space-x-4 items-center">
          <div id="nav-tabs" class="space-x-2">
            <a
              th:href="@{/student/{id}/dashboard(id=${currentUser.studentId})}"
              class="tab-btn"
              >Dashboard</a
            >
            <a href="#" id="nav-booking-link" class="tab-btn active"
              >Booking</a
            >
          </div>
          <span
            id="user-info"
            class="text-sm text-gray-600 font-medium sm:inline"
            th:text="${currentUser.name} + ' (' + ${currentUser.role} + ')'"
          >
            User Name (Role)
          </span>
        </div>
      </nav>

      <div id="message-box" class="fixed top-5 right-5 z-50"></div>

      <div id="booking-view" class="view" style="display: block">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">
          Select a Machine and Time
        </h2>
        <div id="machine-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <p>Loading machines...</p>
        </div>
      </div>

      <div id="confirm-view" class="view">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">
          Confirm Your Booking
        </h2>
        <div class="card max-w-lg mx-auto !p-8">
          <p class="text-lg text-gray-600 mb-4">
            Please confirm the details below:
          </p>
          <ul class="space-y-3 mb-6">
            <li class="flex justify-between items-center">
              <span class="font-medium text-gray-500">User:</span>
              <span
                id="confirm-user"
                class="text-lg font-semibold text-gray-800"
              ></span>
            </li>
            <li class="flex justify-between items-center">
              <span class="font-medium text-gray-500">Machine:</span>
              <span
                id="confirm-machine"
                class="text-lg font-semibold text-gray-800"
              ></span>
            </li>
            <li class="flex justify-between items-center">
              <span class="font-medium text-gray-500">Time Slot:</span>
              <span
                id="confirm-slot"
                class="text-lg font-semibold text-gray-800"
              ></span>
            </li>
          </ul>
          <div class="flex justify-between space-x-4">
            <button
              id="cancel-booking-btn"
              class="w-full text-center py-3 rounded-lg cancel-btn"
            >
              Cancel
            </button>
            <button
              id="submit-booking-btn"
              class="w-full text-center py-3 rounded-lg submit-btn"
            >
              Confirm & Request Approval
            </button>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      /*
       * This passes the real user's name (from the controller)
       * to your JavaScript 'currentUserName' variable.
       */
      const currentUserName = /*[[${currentUser.name}]]*/ "User";

      // We also need the user's ID to create the booking
      const currentUserId = /*[[${currentUser.id}]]*/ null;
    </script>

    <script>
      // --- GLOBAL DATA & STATE ---
      let pendingBooking = null;

      // --- UTILITIES ---
      function showMessage(message, type = "info") {
        const baseClass =
          "p-4 mb-2 rounded-lg shadow-lg text-white font-semibold transition-opacity duration-300";
        let colorClass =
          type === "success"
            ? "bg-emerald-500"
            : type === "error"
            ? "bg-red-500"
            : "bg-blue-500";
        const $msg = $(
          `<div class="${baseClass} ${colorClass}">${message}</div>`
        );
        $("#message-box").append($msg);
        $msg
          .fadeIn(300)
          .delay(3000)
          .fadeOut(500, function () {
            $(this).remove();
          });
      }

      function showView(viewId) {
        $(".view").hide();
        $(`#${viewId}`).show();
      }

      // --- RENDER MACHINES AND SLOTS ---
      function renderMachineSlots() {
        const $list = $("#machine-list").empty();

        // TODO: This should be loaded from your API in the future
        const machines = [
          { id: 1, name: "Washer 1" },
          { id: 2, name: "Washer 2" },
          { id: 3, name: "Washer 3" },
          { id: 4, name: "Washer 4" },
        ];

        const timeSlots = [
          "09:00", "10:00", "11:00", "12:00",
          "13:00", "14:00", "15:00", "16:00",
        ];

        machines.forEach((machine) => {
          let slotButtonsHTML = "";
          timeSlots.forEach((slotTime) => {
            slotButtonsHTML += `
                <button class="slot-button" 
                        data-machine-id="${machine.id}"
                        data-machine-name="${machine.name}" 
                        data-slot-time="${slotTime}">
                    ${slotTime}
                </button>
              `;
          });

          const machineCardHTML = `
                <div class="card">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${machine.name}</h3>
                    <div class="grid grid-cols-4 gap-2">
                        ${slotButtonsHTML}
                    </div>
                </div>
              `;
          $list.append(machineCardHTML);
        });
      }

      // --- BOOKING LOGIC ---

      // 1. Handle click on a time slot button
      $("#machine-list").on("click", ".slot-button", function () {
        const machineId = $(this).data("machine-id");
        const machineName = $(this).data("machine-name");
        const startTime = $(this).data("slot-time");

        const startHour = parseInt(startTime.split(":")[0]);
        const endTime = `${String(startHour + 1).padStart(2, "0")}:00`;

        pendingBooking = {
          userId: currentUserId, // The real user's ID
          machineId: machineId, // The real machine's ID
          machineName: machineName, // Name for display
          user: currentUserName, // Name for display (ที่ดึงมาจาก th:inline)
          startTime: startTime,
          endTime: endTime,
          slot: `${startTime} - ${endTime}`,
        };

        $("#confirm-user").text(pendingBooking.user);
        $("#confirm-machine").text(pendingBooking.machineName);
        $("#confirm-slot").text(pendingBooking.slot);

        showView("confirm-view");
      });

      // 2. Handle Cancel button
      $("#cancel-booking-btn").on("click", function () {
        pendingBooking = null;
        showView("booking-view");
      });

      // 3. Handle Submit button -> Call the API
      $("#submit-booking-btn").on("click", function () {
        if (!pendingBooking) return;

        // ... (ข้อมูล API ไม่เปลี่ยนแปลง)
        const bookingData = {
          user: { id: pendingBooking.userId }, 
          machine: { id: pendingBooking.machineId }, 
          startTime: pendingBooking.startTime,
          endTime: pendingBooking.endTime, 
          status: "PENDING", 
        };

        showMessage(
          "Booking submitted (placeholder)! Redirecting...",
          "success"
        );
        console.log("Data to send to API:", JSON.stringify(bookingData));

        setTimeout(() => {
          // 1. บันทึกข้อมูลการจอง
          sessionStorage.setItem(
            "pendingBooking",
            JSON.stringify(pendingBooking)
          );

          // 2. ⬇️⬇️⬇️ [แก้ไขลิงก์ที่นี่] ⬇️⬇️⬇️
          //    ลิงก์ไปยัง URL ที่มี Controller เพื่อป้องกันการ "หลุด" ล็อกอิน
          if(currentUserId) {
            window.location.href = `/student/${currentUserId}/confirm`;
          } else {
            showMessage("Error: Could not find User ID. Cannot proceed.", "error");
            console.error("currentUserId is null. Cannot build redirect URL.");
          }
        }, 1500);
      });

      // --- INITIALIZATION ---
      $(document).ready(function () {
        if (currentUserId === null) {
            showMessage("Error: Could not identify user.", "error");
            // ปิดการใช้งานปุ่มจองถ้าไม่มี User ID
            $("#machine-list").empty().append("<p class='text-red-500'>Error loading user data. Please try logging in again.</p>");
        } else {
            renderMachineSlots();
        }
      });
    </script>
  </body>
</html>

